'use client';

import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';

type Locale = 'en' | 'pt' | 'es';

type Dictionary = Record<string, string>;

type I18nContextValue = {
  locale: Locale;
  setLocale: (locale: Locale) => void;
  t: (key: string) => string;
};

const dictionaries: Record<Locale, Dictionary> = {
  en: {
    'app.brand': 'ChatFlow',
    'nav.login': 'Login',
    'nav.signup': 'Sign Up',
    'nav.theme.light': 'Light mode',
    'nav.theme.dark': 'Dark mode',
    'nav.theme.toggle': 'Toggle theme',
    'landing.title': 'Connect intelligently',
    'landing.subtitle': 'A modern real-time communication platform with integrated AI. Chat with friends, share ideas, and get AI assistance when needed.',
    'landing.google': 'Continue with Google',
    'landing.github': 'Continue with GitHub',
    'landing.feature.realtime.title': 'Real-time Messages',
    'landing.feature.realtime.desc': 'Instant conversations with WebSocket. See when your friends are typing.',
    'landing.feature.ai.title': 'AI Assistant',
    'landing.feature.ai.desc': 'AI built-in to help you in your conversations.',
    'landing.feature.secure.title': 'Secure & Private',
    'landing.feature.secure.desc': 'Secure OAuth2 authentication. Your conversations are private and encrypted.',
    'landing.cta.title': 'Ready to get started?',
    'landing.cta.subtitle': 'Join now and connect with friends intelligently',
    'landing.cta.button': 'Get Started',
    'dashboard.welcome.title': 'Welcome to ChatFlow',
    'dashboard.welcome.subtitle': 'Select a conversation in the sidebar or add new friends to start chatting',
    'dashboard.welcome.addFriend': 'Add Friend',
    'dashboard.welcome.aiChat': 'AI Chat',
    'dashboard.search.placeholder': 'Search messages in chats...',
    'dashboard.search.loading': 'Searching...',
    'dashboard.search.empty': 'No conversations found.',
    'dashboard.search.authorPrefix': ': ',
    'dashboard.sidebar.actions.addFriend': 'Add Friend',
    'dashboard.sidebar.actions.aiChat': 'AI Chat',
    'dashboard.sidebar.actions.aiChat.loading': 'Creating...',
    'dashboard.sidebar.conversations.title': 'CONVERSATIONS',
    'dashboard.sidebar.conversations.empty.title': 'No conversations yet',
    'dashboard.sidebar.conversations.empty.subtitle': 'Add friends to start',
    'dashboard.chat.delete.title': 'Delete Conversation?',
    'dashboard.chat.delete.body': 'Are you sure you want to delete this conversation? All messages will be permanently removed.',
    'dashboard.chat.delete.cancel': 'Cancel',
    'dashboard.chat.delete.confirm': 'Delete',
    'dashboard.chat.delete.confirming': 'Deleting...',
    'dashboard.logout': 'Logout',
    'dashboard.security': 'Security (2FA)',
    'modal.friends.title': 'Friends',
    'modal.friends.search': 'Search',
    'modal.friends.requests': 'Requests',
    'modal.friends.search.placeholder': 'Search by name or email...',
    'modal.friends.search.empty': 'No users found',
    'modal.friends.search.helper': 'Type at least 2 characters to search',
    'modal.friends.friend': 'Friend',
    'modal.friends.pending': 'Request sent',
    'modal.friends.unknownUser': 'Unknown user',
    'modal.friends.add': 'Add',
    'modal.friends.accept': 'Accept',
    'modal.friends.reject': 'Reject',
    'modal.friends.pending.title': 'Pending requests',
    'modal.friends.requests.empty': 'No pending requests',
    'login.title': 'Welcome Back',
    'login.subtitle': 'Sign in to continue your conversations',
    'login.google': 'Continue with Google',
    'login.github': 'Continue with GitHub',
    'login.divider': 'or continue with email',
    'login.email': 'Email',
    'login.password': 'Password',
    'login.submit': 'Sign In',
    'login.footer': "Don't have an account?",
    'login.footer.link': 'Sign up',
    'signup.title': 'Create Account',
    'signup.subtitle': 'Start your AI conversation journey',
    'signup.google': 'Sign up with Google',
    'signup.github': 'Sign up with GitHub',
    'signup.divider': 'or sign up with email',
    'signup.name': 'Name',
    'signup.email': 'Email',
    'signup.password': 'Password',
    'signup.passwordConfirm': 'Confirm password',
    'signup.error': 'Unable to create account.',
    'signup.submit': 'Create Account',
    'signup.footer': 'Already have an account?',
    'signup.footer.link': 'Sign in',
    'auth.callback.loading': 'Authenticating...',
    'auth.2fa.title': '2FA Verification',
    'auth.2fa.subtitle': 'Enter the code from your authenticator app or a recovery code.',
    'auth.2fa.code': '2FA Code',
    'auth.2fa.recovery': 'Recovery code (optional)',
    'auth.2fa.submit': 'Verify',
    'auth.2fa.invalid': 'Invalid code.',
    'settings.2fa.title': 'Security - 2FA',
    'settings.2fa.subtitle': 'Enable two-step authentication to protect your account. Scan the QR Code with your authenticator.',
    'settings.2fa.enabled': '2FA enabled. Confirm with your authenticator app code.',
    'settings.2fa.confirmed': '2FA confirmed successfully.',
    'settings.2fa.error.enable': 'Unable to enable 2FA.',
    'settings.2fa.error.confirm': 'Invalid code.',
    'settings.2fa.error.disable': 'Unable to disable 2FA.',
    'settings.2fa.error.codes': 'Unable to generate new codes.',
    'settings.2fa.disabled': '2FA disabled.',
    'settings.2fa.codes.updated': 'Recovery codes updated.',
    'settings.2fa.button.enable': 'Enable 2FA',
    'settings.2fa.button.confirm': 'Confirm 2FA',
    'settings.2fa.button.disable': 'Disable 2FA',
    'settings.2fa.button.regenerate': 'Generate new codes',
    'settings.2fa.qr.hint': 'Scan with your authenticator app to link your account.',
    'settings.2fa.input.code': 'Authenticator app code',
    'settings.2fa.codes.title': 'Recovery codes',
    'settings.2fa.codes.empty': 'No codes available.',
    'settings.back': 'Back',
    'chat.ai.title': 'AI Assistant',
    'chat.status.online': 'Online',
    'chat.you': 'You',
    'chat.ai.typing': 'AI Assistant',
    'chat.input.placeholder': 'Type a message...',
    'chat.private.title': 'Private chat',
    'chat.input.private.placeholder': 'Type your message...',
  },
  pt: {
    'app.brand': 'ChatFlow',
    'nav.login': 'Entrar',
    'nav.signup': 'Criar conta',
    'nav.theme.light': 'Modo claro',
    'nav.theme.dark': 'Modo escuro',
    'nav.theme.toggle': 'Alternar tema',
    'landing.title': 'Conecte-se de forma inteligente',
    'landing.subtitle': 'Uma plataforma moderna de comunicação em tempo real com inteligência artificial integrada. Converse com amigos, compartilhe ideias e conte com assistência IA quando precisar.',
    'landing.google': 'Entrar com Google',
    'landing.github': 'Entrar com GitHub',
    'landing.feature.realtime.title': 'Mensagens em Tempo Real',
    'landing.feature.realtime.desc': 'Conversas instantâneas com WebSocket. Veja quando seus amigos estão digitando.',
    'landing.feature.ai.title': 'Assistente com IA',
    'landing.feature.ai.desc': 'Conte com inteligência artificial integrada para auxiliar em suas conversas.',
    'landing.feature.secure.title': 'Seguro e Privado',
    'landing.feature.secure.desc': 'Autenticação OAuth2 segura. Suas conversas são privadas e criptografadas.',
    'landing.cta.title': 'Pronto para começar?',
    'landing.cta.subtitle': 'Entre agora e conecte-se com amigos de forma inteligente',
    'landing.cta.button': 'Começar Agora',
    'dashboard.welcome.title': 'Bem-vindo ao ChatFlow',
    'dashboard.welcome.subtitle': 'Selecione uma conversa na barra lateral ou adicione novos amigos para começar a conversar',
    'dashboard.welcome.addFriend': 'Adicionar Amigo',
    'dashboard.welcome.aiChat': 'Chat com IA',
    'dashboard.search.placeholder': 'Pesquisar mensagens em chats...',
    'dashboard.search.loading': 'Pesquisando...',
    'dashboard.search.empty': 'Nenhuma conversa encontrada.',
    'dashboard.search.authorPrefix': ': ',
    'dashboard.sidebar.actions.addFriend': 'Adicionar Amigo',
    'dashboard.sidebar.actions.aiChat': 'Chat com IA',
    'dashboard.sidebar.actions.aiChat.loading': 'Criando...',
    'dashboard.sidebar.conversations.title': 'CONVERSAS',
    'dashboard.sidebar.conversations.empty.title': 'Nenhuma conversa ainda',
    'dashboard.sidebar.conversations.empty.subtitle': 'Adicione amigos para começar',
    'dashboard.chat.delete.title': 'Excluir Conversa?',
    'dashboard.chat.delete.body': 'Tem certeza que deseja excluir esta conversa? Todas as mensagens serão permanentemente removidas.',
    'dashboard.chat.delete.cancel': 'Cancelar',
    'dashboard.chat.delete.confirm': 'Excluir',
    'dashboard.chat.delete.confirming': 'Excluindo...',
    'dashboard.logout': 'Sair',
    'dashboard.security': 'Segurança (2FA)',
    'modal.friends.title': 'Amigos',
    'modal.friends.search': 'Buscar',
    'modal.friends.requests': 'Solicitações',
    'modal.friends.search.placeholder': 'Buscar por nome ou email...',
    'modal.friends.search.empty': 'Nenhum usuário encontrado',
    'modal.friends.search.helper': 'Digite pelo menos 2 caracteres para buscar',
    'modal.friends.friend': 'Amigo',
    'modal.friends.pending': 'Pedido enviado',
    'modal.friends.unknownUser': 'Usuário desconhecido',
    'modal.friends.add': 'Adicionar',
    'modal.friends.accept': 'Aceitar',
    'modal.friends.reject': 'Rejeitar',
    'modal.friends.pending.title': 'Solicitações pendentes',
    'modal.friends.requests.empty': 'Nenhuma solicitação pendente',
    'login.title': 'Bem-vindo de volta',
    'login.subtitle': 'Entre para continuar suas conversas',
    'login.google': 'Continue com Google',
    'login.github': 'Continue com GitHub',
    'login.divider': 'ou continue com email',
    'login.email': 'Email',
    'login.password': 'Senha',
    'login.submit': 'Entrar',
    'login.footer': 'Não tem uma conta?',
    'login.footer.link': 'Criar conta',
    'signup.title': 'Criar conta',
    'signup.subtitle': 'Comece sua jornada de conversas com IA',
    'signup.google': 'Entrar com Google',
    'signup.github': 'Entrar com GitHub',
    'signup.divider': 'ou cadastre-se com email',
    'signup.name': 'Nome',
    'signup.email': 'Email',
    'signup.password': 'Senha',
    'signup.passwordConfirm': 'Confirmar senha',
    'signup.error': 'Não foi possível criar a conta.',
    'signup.submit': 'Criar conta',
    'signup.footer': 'Já tem uma conta?',
    'signup.footer.link': 'Entrar',
    'auth.callback.loading': 'Autenticando...',
    'auth.2fa.title': 'Verificação 2FA',
    'auth.2fa.subtitle': 'Digite o código do seu aplicativo autenticador ou um código de recuperação.',
    'auth.2fa.code': 'Código 2FA',
    'auth.2fa.recovery': 'Código de recuperação (opcional)',
    'auth.2fa.submit': 'Verificar',
    'auth.2fa.invalid': 'Código inválido.',
    'settings.2fa.title': 'Segurança - 2FA',
    'settings.2fa.subtitle': 'Ative a autenticação em duas etapas para proteger sua conta. Escaneie o QR Code com seu autenticador.',
    'settings.2fa.enabled': '2FA ativado. Confirme com o código do app autenticador.',
    'settings.2fa.confirmed': '2FA confirmado com sucesso.',
    'settings.2fa.error.enable': 'Não foi possível ativar o 2FA.',
    'settings.2fa.error.confirm': 'Código inválido.',
    'settings.2fa.error.disable': 'Não foi possível desativar o 2FA.',
    'settings.2fa.error.codes': 'Não foi possível gerar novos códigos.',
    'settings.2fa.disabled': '2FA desativado.',
    'settings.2fa.codes.updated': 'Códigos de recuperação atualizados.',
    'settings.2fa.button.enable': 'Ativar 2FA',
    'settings.2fa.button.confirm': 'Confirmar 2FA',
    'settings.2fa.button.disable': 'Desativar 2FA',
    'settings.2fa.button.regenerate': 'Gerar novos códigos',
    'settings.2fa.qr.hint': 'Escaneie com seu app autenticador para vincular sua conta.',
    'settings.2fa.input.code': 'Código do app autenticador',
    'settings.2fa.codes.title': 'Códigos de recuperação',
    'settings.2fa.codes.empty': 'Nenhum código disponível.',
    'settings.back': 'Voltar',
    'chat.ai.title': 'Assistente com IA',
    'chat.status.online': 'Online',
    'chat.you': 'Você',
    'chat.ai.typing': 'Assistente com IA',
    'chat.input.placeholder': 'Digite uma mensagem...',
    'chat.private.title': 'Conversa privada',
    'chat.input.private.placeholder': 'Digite sua mensagem...',
  },
  es: {
    'app.brand': 'ChatFlow',
    'nav.login': 'Iniciar sesión',
    'nav.signup': 'Crear cuenta',
    'nav.theme.light': 'Modo claro',
    'nav.theme.dark': 'Modo oscuro',
    'nav.theme.toggle': 'Cambiar tema',
    'landing.title': 'Conéctate de forma inteligente',
    'landing.subtitle': 'Una plataforma moderna de comunicación en tiempo real con IA integrada. Conversa con amigos, comparte ideas y recibe ayuda de IA cuando lo necesites.',
    'landing.google': 'Continuar con Google',
    'landing.github': 'Continuar con GitHub',
    'landing.feature.realtime.title': 'Mensajes en tiempo real',
    'landing.feature.realtime.desc': 'Conversaciones instantáneas con WebSocket. Ve cuando tus amigos están escribiendo.',
    'landing.feature.ai.title': 'Asistente con IA',
    'landing.feature.ai.desc': 'IA integrada para ayudar en tus conversaciones.',
    'landing.feature.secure.title': 'Seguro y privado',
    'landing.feature.secure.desc': 'Autenticación OAuth2 segura. Tus conversaciones son privadas y cifradas.',
    'landing.cta.title': '¿Listo para empezar?',
    'landing.cta.subtitle': 'Únete ahora y conéctate con amigos de forma inteligente',
    'landing.cta.button': 'Empezar ahora',
    'dashboard.welcome.title': 'Bienvenido a ChatFlow',
    'dashboard.welcome.subtitle': 'Selecciona una conversación en la barra lateral o agrega nuevos amigos para empezar a chatear',
    'dashboard.welcome.addFriend': 'Agregar amigo',
    'dashboard.welcome.aiChat': 'Chat con IA',
    'dashboard.search.placeholder': 'Buscar mensajes en chats...',
    'dashboard.search.loading': 'Buscando...',
    'dashboard.search.empty': 'No se encontraron conversaciones.',
    'dashboard.search.authorPrefix': ': ',
    'dashboard.sidebar.actions.addFriend': 'Agregar amigo',
    'dashboard.sidebar.actions.aiChat': 'Chat con IA',
    'dashboard.sidebar.actions.aiChat.loading': 'Creando...',
    'dashboard.sidebar.conversations.title': 'CONVERSACIONES',
    'dashboard.sidebar.conversations.empty.title': 'No hay conversaciones todavía',
    'dashboard.sidebar.conversations.empty.subtitle': 'Agrega amigos para empezar',
    'dashboard.chat.delete.title': '¿Eliminar conversación?',
    'dashboard.chat.delete.body': '¿Seguro que deseas eliminar esta conversación? Todos los mensajes serán eliminados permanentemente.',
    'dashboard.chat.delete.cancel': 'Cancelar',
    'dashboard.chat.delete.confirm': 'Eliminar',
    'dashboard.chat.delete.confirming': 'Eliminando...',
    'dashboard.logout': 'Cerrar sesión',
    'dashboard.security': 'Seguridad (2FA)',
    'modal.friends.title': 'Amigos',
    'modal.friends.search': 'Buscar',
    'modal.friends.requests': 'Solicitudes',
    'modal.friends.search.placeholder': 'Buscar por nombre o correo...',
    'modal.friends.search.empty': 'No se encontraron usuarios',
    'modal.friends.search.helper': 'Escribe al menos 2 caracteres para buscar',
    'modal.friends.friend': 'Amigo',
    'modal.friends.pending': 'Solicitud enviada',
    'modal.friends.unknownUser': 'Usuario desconocido',
    'modal.friends.add': 'Agregar',
    'modal.friends.accept': 'Aceptar',
    'modal.friends.reject': 'Rechazar',
    'modal.friends.pending.title': 'Solicitudes pendientes',
    'modal.friends.requests.empty': 'No hay solicitudes pendientes',
    'login.title': 'Bienvenido de nuevo',
    'login.subtitle': 'Inicia sesión para continuar tus conversaciones',
    'login.google': 'Continuar con Google',
    'login.github': 'Continuar con GitHub',
    'login.divider': 'o continuar con email',
    'login.email': 'Email',
    'login.password': 'Contraseña',
    'login.submit': 'Iniciar sesión',
    'login.footer': '¿No tienes cuenta?',
    'login.footer.link': 'Crear cuenta',
    'signup.title': 'Crear cuenta',
    'signup.subtitle': 'Comienza tu viaje con IA',
    'signup.google': 'Regístrate con Google',
    'signup.github': 'Regístrate con GitHub',
    'signup.divider': 'o regístrate con email',
    'signup.name': 'Nombre',
    'signup.email': 'Email',
    'signup.password': 'Contraseña',
    'signup.passwordConfirm': 'Confirmar contraseña',
    'signup.error': 'No se pudo crear la cuenta.',
    'signup.submit': 'Crear cuenta',
    'signup.footer': '¿Ya tienes cuenta?',
    'signup.footer.link': 'Iniciar sesión',
    'auth.callback.loading': 'Autenticando...',
    'auth.2fa.title': 'Verificación 2FA',
    'auth.2fa.subtitle': 'Ingresa el código de tu app autenticadora o un código de recuperación.',
    'auth.2fa.code': 'Código 2FA',
    'auth.2fa.recovery': 'Código de recuperación (opcional)',
    'auth.2fa.submit': 'Verificar',
    'auth.2fa.invalid': 'Código inválido.',
    'settings.2fa.title': 'Seguridad - 2FA',
    'settings.2fa.subtitle': 'Activa la autenticación de dos pasos para proteger tu cuenta. Escanea el código QR con tu autenticador.',
    'settings.2fa.enabled': '2FA activado. Confirma con el código de tu autenticador.',
    'settings.2fa.confirmed': '2FA confirmado correctamente.',
    'settings.2fa.error.enable': 'No se pudo activar 2FA.',
    'settings.2fa.error.confirm': 'Código inválido.',
    'settings.2fa.error.disable': 'No se pudo desactivar 2FA.',
    'settings.2fa.error.codes': 'No se pudieron generar nuevos códigos.',
    'settings.2fa.disabled': '2FA desactivado.',
    'settings.2fa.codes.updated': 'Códigos de recuperación actualizados.',
    'settings.2fa.button.enable': 'Activar 2FA',
    'settings.2fa.button.confirm': 'Confirmar 2FA',
    'settings.2fa.button.disable': 'Desactivar 2FA',
    'settings.2fa.button.regenerate': 'Generar nuevos códigos',
    'settings.2fa.qr.hint': 'Escanea con tu autenticador para vincular la cuenta.',
    'settings.2fa.input.code': 'Código del autenticador',
    'settings.2fa.codes.title': 'Códigos de recuperación',
    'settings.2fa.codes.empty': 'No hay códigos disponibles.',
    'settings.back': 'Volver',
    'chat.ai.title': 'Asistente con IA',
    'chat.status.online': 'En línea',
    'chat.you': 'Tú',
    'chat.ai.typing': 'Asistente con IA',
    'chat.input.placeholder': 'Escribe un mensaje...',
    'chat.private.title': 'Chat privado',
    'chat.input.private.placeholder': 'Escribe tu mensaje...',
  },
};

const I18nContext = createContext<I18nContextValue | undefined>(undefined);

const getInitialLocale = (): Locale => {
  if (typeof window === 'undefined') return 'pt';
  const stored = localStorage.getItem('locale') as Locale | null;
  if (stored && ['en', 'pt', 'es'].includes(stored)) return stored;
  const browser = navigator.language.toLowerCase();
  if (browser.startsWith('es')) return 'es';
  if (browser.startsWith('pt')) return 'pt';
  return 'en';
};

export function I18nProvider({ children }: { children: React.ReactNode }) {
  const [locale, setLocaleState] = useState<Locale>('pt');

  useEffect(() => {
    setLocaleState(getInitialLocale());
  }, []);

  const setLocale = (next: Locale) => {
    setLocaleState(next);
    if (typeof window !== 'undefined') {
      localStorage.setItem('locale', next);
    }
  };

  const t = useMemo(() => {
    const dict = dictionaries[locale] || dictionaries.pt;
    return (key: string) => dict[key] || dictionaries.pt[key] || key;
  }, [locale]);

  const value: I18nContextValue = { locale, setLocale, t };

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n must be used within I18nProvider');
  }
  return context;
}
